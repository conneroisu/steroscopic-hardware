<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# despair

```go
import "github.com/conneroisu/steroscopic-hardware/pkg/despair"
```

Package despair provides a Go implementation of a stereoscopic depth mapping algorithm, designed for efficient generation of depth/disparity maps from stereo image pairs.

### Core Functionality

The package implements the Sum of Absolute Differences \(SAD\) algorithm, a common technique in stereoscopic vision that:

1. Takes left and right grayscale images from slightly different viewpoints
2. Compares blocks of pixels to find matching points between images
3. Calculates disparity \(horizontal displacement\) between matching points
4. Generates a grayscale disparity map where pixel brightness represents depth

### Data Structures

```
InputChunk: Represents a portion of the image pair to process
OutputChunk: Contains processed disparity data for a specific region
Parameters: Configuration settings for the algorithm including:
`BlockSize`: Size of pixel blocks for comparison
`MaxDisparity`: Maximum pixel displacement to check
```

### Processing Pipeline

1. \`SetupConcurrentSAD\`: Creates a pipeline with configurable worker count, returning input/output channels

2. \`RunSad\`: Convenience function that orchestrates the entire process: \- Divides images into chunks \- Distributes processing across workers \- Assembles final disparity map

3. \`AssembleDisparityMap\`: Combines processed chunks into a complete disparity map

4. \`sumAbsoluteDifferences\`: Low\-level function that calculates block matching scores

### Image Handling

The package includes efficient image handling utilities:

- PNG Loading/Saving: Optimized functions for loading and saving grayscale PNG images
- Type\-Specific Conversions: Specialized routines for different image formats \(Gray, RGBA, generic\)
- Error Handling: Both standard error\-returning functions and "Must" variants that panic on failure

### Performance Optimizations

- Concurrent Processing: Utilizes Go's concurrency with multiple worker goroutines
- Chunked Processing: Splits images into smaller regions for parallel processing
- Direct Pixel Access: Works with underlying pixel arrays rather than the higher\-level interface
- Type\-Specific Optimizations: Different code paths for different image types
- Early Termination: Breaks comparison loops when perfect matches are found
- Optimized Bounds Checking: Reduces redundant checks in inner loops
- Precomputed Lookup Tables: Uses LUTs for common conversions

Example:

```
```go
// Load stereo image pair
left := despair.MustLoadPNG("left.png")
right := despair.MustLoadPNG("right.png")

// Generate disparity map with block size 9 and max disparity 64
disparityMap := despair.RunSad(left, right, 9, 64)

// Save the result
despair.MustSavePNG("depth_map.png", disparityMap)
```
```

## Index

- [func AssembleDisparityMap\(outputChan \<\-chan OutputChunk, dimensions image.Rectangle, chunks int\) \*image.Gray](<#AssembleDisparityMap>)
- [func LoadPNG\(filename string\) \(\*image.Gray, error\)](<#LoadPNG>)
- [func MustLoadPNG\(filename string\) \*image.Gray](<#MustLoadPNG>)
- [func MustSavePNG\(filename string, img image.Image\)](<#MustSavePNG>)
- [func RunSad\(left, right \*image.Gray, blockSize, maxDisparity int\) \*image.Gray](<#RunSad>)
- [func SavePNG\(filename string, img image.Image\) error](<#SavePNG>)
- [func SetupConcurrentSAD\(params \*Parameters, numWorkers int\) \(chan\<\- InputChunk, \<\-chan OutputChunk\)](<#SetupConcurrentSAD>)
- [type InputChunk](<#InputChunk>)
- [type OutputChunk](<#OutputChunk>)
- [type Parameters](<#Parameters>)
  - [func \(p \*Parameters\) Lock\(\)](<#Parameters.Lock>)
  - [func \(p \*Parameters\) Unlock\(\)](<#Parameters.Unlock>)


<a name="AssembleDisparityMap"></a>
## func [AssembleDisparityMap](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/sad.go#L168-L172>)

```go
func AssembleDisparityMap(outputChan <-chan OutputChunk, dimensions image.Rectangle, chunks int) *image.Gray
```

AssembleDisparityMap assembles the disparity map from output chunks

<a name="LoadPNG"></a>
## func [LoadPNG](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/png.go#L10>)

```go
func LoadPNG(filename string) (*image.Gray, error)
```

LoadPNG loads a PNG image and converts it to grayscale with optimizations

<a name="MustLoadPNG"></a>
## func [MustLoadPNG](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/png.go#L44>)

```go
func MustLoadPNG(filename string) *image.Gray
```

MustLoadPNG loads a PNG image and converts it to grayscale with optimizations and panics if an error occurs.

<a name="MustSavePNG"></a>
## func [MustSavePNG](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/png.go#L68>)

```go
func MustSavePNG(filename string, img image.Image)
```

MustSavePNG saves a PNG image with optimizations to the given filename and panics if an error occurs.

<a name="RunSad"></a>
## func [RunSad](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/sad.go#L116-L119>)

```go
func RunSad(left, right *image.Gray, blockSize, maxDisparity int) *image.Gray
```

RunSad is a convenience function that sets up the pipeline, feeds the images, and assembles the disparity map.

This is not used in the web UI, but is useful for testing.

<a name="SavePNG"></a>
## func [SavePNG](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/png.go#L54>)

```go
func SavePNG(filename string, img image.Image) error
```

SavePNG saves a PNG image with optimizations to the given filename and returns an error if one occurs.

<a name="SetupConcurrentSAD"></a>
## func [SetupConcurrentSAD](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/sad.go#L28-L31>)

```go
func SetupConcurrentSAD(params *Parameters, numWorkers int) (chan<- InputChunk, <-chan OutputChunk)
```

SetupConcurrentSAD sets up a concurrent SAD processing pipeline It returns an input channel to feed image chunks into and an output channel to receive results from.

If the input channel is closed, the processing pipeline will stop.

<a name="InputChunk"></a>
## type [InputChunk](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/sad.go#L12-L15>)

InputChunk represents a portion of the image to process

```go
type InputChunk struct {
    Left, Right *image.Gray
    Region      image.Rectangle
}
```

<a name="OutputChunk"></a>
## type [OutputChunk](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/sad.go#L18-L21>)

OutputChunk represents the processed disparity data for a region

```go
type OutputChunk struct {
    DisparityData []uint8
    Region        image.Rectangle
}
```

<a name="Parameters"></a>
## type [Parameters](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/params.go#L9-L13>)

Parameters is a struct that holds the parameters for the stereoscopic image processing.

```go
type Parameters struct {
    BlockSize    int `json:"blockSize"`
    MaxDisparity int `json:"maxDisparity"`
    // contains filtered or unexported fields
}
```

<a name="Parameters.Lock"></a>
### func \(\*Parameters\) [Lock](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/params.go#L16>)

```go
func (p *Parameters) Lock()
```

Lock locks the mutex.

<a name="Parameters.Unlock"></a>
### func \(\*Parameters\) [Unlock](<https://github.com/conneroisu/steroscopic-hardware/blob/main/pkg/despair/params.go#L19>)

```go
func (p *Parameters) Unlock()
```

Unlock unlocks the mutex.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->
