# handlers

Http handlers for the web ui can be found here.

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# handlers

```go
import "github.com/conneroisu/steroscopic-hardware/cmd/handlers"
```

Package handlers contains functions for handling API requests.

This Go package \`handlers\` is part of a stereoscopic hardware system project that manages HTTP requests for a web UI controlling stereo cameras.

It handles the communication between the web interface and the physical camera hardware.

\#\# Core Components

\#\#\# API Handling Structure

- \`APIFn\` is the fundamental type \- a function signature that processes HTTP requests and returns errors
- \`Make\(\)\` converts these API functions into standard HTTP handlers, with built\-in error handling
- \`ErrorHandler\(\)\` wraps API functions to provide formatted HTML error responses \(using color\-coded success/failure messages\)

\#\#\# Key Handlers

1. \*\*Camera Configuration \(\`ConfigureCamera\`\):\*\* \- Processes form data for camera setup \(port, baud rate, compression\) \- Configures either left or right camera streams based on parameters \- Creates new output streams after successful configuration \- Includes validation and error handling for all input parameters

2. \*\*Parameters Management \(\`ParametersHandler\`\):\*\* \- Handles changes to disparity map generator parameters \- Processes form data for block size and maximum disparity values \- Uses mutex locking to ensure thread safety when updating shared parameters \- Logs parameter changes for debugging

3. \*\*Port Discovery \(\`GetPorts\`\):\*\* \- Enumerates and returns available serial ports as HTML options \- Implements retry logic \(up to 10 attempts\) if ports aren't initially found \- Formats port information for direct use in form select elements

4. \*\*Image Streaming \(\`StreamHandlerFn\`\):\*\* \- Sets up MJPEG streaming with multipart boundaries \- Manages client registration and connection lifecycle \- Implements performance optimizations: \- Buffer pooling to minimize memory allocation \- JPEG quality control and compression \- Frame rate limiting \(10 FPS\) \- Connection timeouts \(30 minutes\) \- Efficient image encoding with reusable buffers

\#\#\# UI Integration

- \`MorphableHandler\(\)\` supports HTMX integration by detecting the presence of HX\-Request headers
- Serves either full page or partial content based on request type, enabling dynamic UI updates without full page reloads

\#\# Technical Design Highlights

- Thread safety with mutex locks for parameter updates
- Memory efficiency through object pooling \(JPEG options\)
- Graceful error handling with formatted responses
- Efficient image streaming with buffer reuse
- Robust port detection with retry mechanisms
- Context\-aware logging throughout the system

This package serves as the interface layer between the web UI and the underlying stereoscopic hardware, providing both configuration management and real\-time image streaming capabilities.

## Index

- [func HandleLeftStream\(w http.ResponseWriter, r \*http.Request\) error](<#HandleLeftStream>)
- [func HandleOutputStream\(w http.ResponseWriter, r \*http.Request\) error](<#HandleOutputStream>)
- [func HandleRightStream\(w http.ResponseWriter, r \*http.Request\) error](<#HandleRightStream>)
- [func Make\(fn APIFn\) http.HandlerFunc](<#Make>)
- [func MorphableHandler\(wrapper func\(templ.Component\) templ.Component, morph templ.Component\) http.HandlerFunc](<#MorphableHandler>)
- [type APIFn](<#APIFn>)
  - [func ConfigureCamera\(ctx context.Context, typ camera.Type\) APIFn](<#ConfigureCamera>)
  - [func ConfigureMiddleware\(apiFn APIFn\) APIFn](<#ConfigureMiddleware>)
  - [func ErrorHandler\(fn APIFn\) APIFn](<#ErrorHandler>)
  - [func GetPorts\(logger \*logger.Logger\) APIFn](<#GetPorts>)
  - [func HandleCameraStream\(camType camera.Type\) APIFn](<#HandleCameraStream>)
  - [func ParametersHandler\(\) APIFn](<#ParametersHandler>)
  - [func UploadHandler\(appCtx context.Context, typ camera.Type\) APIFn](<#UploadHandler>)
- [type CtxKey](<#CtxKey>)


<a name="HandleLeftStream"></a>
## func [HandleLeftStream](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/stream.go#L40>)

```go
func HandleLeftStream(w http.ResponseWriter, r *http.Request) error
```

HandleLeftStream returns a handler for streaming the left camera.

<a name="HandleOutputStream"></a>
## func [HandleOutputStream](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/stream.go#L50>)

```go
func HandleOutputStream(w http.ResponseWriter, r *http.Request) error
```

HandleOutputStream returns a handler for streaming the output camera.

<a name="HandleRightStream"></a>
## func [HandleRightStream](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/stream.go#L45>)

```go
func HandleRightStream(w http.ResponseWriter, r *http.Request) error
```

HandleRightStream returns a handler for streaming the right camera.

<a name="Make"></a>
## func [Make](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/api.go#L15>)

```go
func Make(fn APIFn) http.HandlerFunc
```

Make returns a function that can be used as an http.HandlerFunc.

<a name="MorphableHandler"></a>
## func [MorphableHandler](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/api.go#L48-L51>)

```go
func MorphableHandler(wrapper func(templ.Component) templ.Component, morph templ.Component) http.HandlerFunc
```

MorphableHandler returns a handler that checks for the presence of the hx\-trigger header and serves either the full or morphed view.

<a name="APIFn"></a>
## type [APIFn](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/api.go#L12>)

APIFn is a function that handles an API request.

```go
type APIFn func(w http.ResponseWriter, r *http.Request) error
```

<a name="ConfigureCamera"></a>
### func [ConfigureCamera](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/configure.go#L77>)

```go
func ConfigureCamera(ctx context.Context, typ camera.Type) APIFn
```

ConfigureCamera handles client requests to configure camera parameters.

<a name="ConfigureMiddleware"></a>
### func [ConfigureMiddleware](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/configure.go#L26>)

```go
func ConfigureMiddleware(apiFn APIFn) APIFn
```

ConfigureMiddleware parses camera configuration from form data.

It adds the configuration to the request context.

This middleware is required for the ConfigureCamera handler.

<a name="ErrorHandler"></a>
### func [ErrorHandler](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/api.go#L63-L65>)

```go
func ErrorHandler(fn APIFn) APIFn
```

ErrorHandler returns a handler that returns an error response.

<a name="GetPorts"></a>
### func [GetPorts](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/ports.go#L14-L16>)

```go
func GetPorts(logger *logger.Logger) APIFn
```

GetPorts handles client requests to configure the camera.

<a name="HandleCameraStream"></a>
### func [HandleCameraStream](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/stream.go#L14>)

```go
func HandleCameraStream(camType camera.Type) APIFn
```

HandleCameraStream is a generic handler for streaming camera images.

<a name="ParametersHandler"></a>
### func [ParametersHandler](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/params.go#L14>)

```go
func ParametersHandler() APIFn
```

ParametersHandler handles client requests to update disparity algorithm parameters.

<a name="UploadHandler"></a>
### func [UploadHandler](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/upload.go#L16>)

```go
func UploadHandler(appCtx context.Context, typ camera.Type) APIFn
```

UploadHandler handles the upload of static image files for camera simulation.

<a name="CtxKey"></a>
## type [CtxKey](<https://github.com/conneroisu/steroscopic-hardware/blob/main/cmd/handlers/configure.go#L15>)

CtxKey is a type alias for context keys used to store camera configuration.

```go
type CtxKey string
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->
